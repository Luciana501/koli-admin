rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if a reward code is expired
    function isRewardExpired(rewardData) {
      return rewardData.expiresAt != null && 
             request.time > rewardData.expiresAt;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    function validPlatformCodeData(data) {
      return data.code is string && data.code.size() > 0 &&
             data.description is string &&
             data.leaderId is string && data.leaderId.size() > 0 &&
             data.leaderName is string && data.leaderName.size() > 0 &&
             data.isActive is bool &&
             data.usageCount is int && data.usageCount >= 0 &&
             (!('maxUses' in data) || data.maxUses == null || (data.maxUses is int && data.maxUses > 0));
    }
    
    // Platform Codes - Allow unauthenticated read for signup gate verification
    match /platformCodes/{codeId} {
      allow read: if true;  // Anyone can check if a code is valid
      allow create: if isAdmin() && validPlatformCodeData(request.resource.data);
      allow update: if isAdmin() && validPlatformCodeData(request.resource.data);
      allow delete: if isAdmin();
    }
    
    // Email OTP Verifications - Allow unauthenticated access for signup flow
    match /emailOtpVerifications/{encodedEmail} {
      // Allow authenticated users to read their own OTP for verification
      allow read: if request.auth != null;
      // Allow anyone to write (for signup before auth and resend)
      allow write: if true;
    }
    
    // Admins collection - MUST come before catch-all rule to avoid circular dependency
    match /admins/{adminId} {
      // Allow authenticated users to read admin docs (needed for role bootstrap checks)
      allow read: if request.auth != null;
      // Only super admins can manage admin accounts (or use admin SDK)
      allow write: if false;
    }
    
    // Members collection
    match /members/{userId} {
      allow read: if isAdmin() || (request.auth != null && (
        request.auth.uid == userId ||
        resource.data.uid == request.auth.uid ||
        resource.data.userId == request.auth.uid ||
        resource.data.memberId == request.auth.uid
      ));

      allow create: if isAdmin() || (request.auth != null && (
        request.auth.uid == userId ||
        request.resource.data.uid == request.auth.uid ||
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.memberId == request.auth.uid
      ));

      allow update: if isAdmin() || (request.auth != null && (
        request.auth.uid == userId ||
        resource.data.uid == request.auth.uid ||
        resource.data.userId == request.auth.uid ||
        resource.data.memberId == request.auth.uid
      ));

      allow delete: if isAdmin();
    }

    // ODHex members and ledger
    match /ODHexMembers/{memberId} {
      allow read: if isAdmin() || (request.auth != null && (
        request.auth.uid == memberId ||
        resource.data.uid == request.auth.uid ||
        resource.data.userId == request.auth.uid ||
        resource.data.memberId == request.auth.uid
      ));

      allow create: if isAdmin() || (request.auth != null && (
        request.resource.data.uid == request.auth.uid ||
        request.resource.data.userId == request.auth.uid ||
        request.resource.data.memberId == request.auth.uid
      ));

      allow update: if isAdmin() || (request.auth != null && (
        request.auth.uid == memberId ||
        resource.data.uid == request.auth.uid ||
        resource.data.userId == request.auth.uid ||
        resource.data.memberId == request.auth.uid
      ));

      allow delete: if isAdmin();
    }

    match /ODHexMembers/{memberId}/odhexLedger/{entryId} {
      allow read: if isAdmin() || (request.auth != null && (
        request.auth.uid == memberId ||
        get(/databases/$(database)/documents/ODHexMembers/$(memberId)).data.uid == request.auth.uid ||
        get(/databases/$(database)/documents/ODHexMembers/$(memberId)).data.userId == request.auth.uid ||
        get(/databases/$(database)/documents/ODHexMembers/$(memberId)).data.memberId == request.auth.uid
      ));
      allow write: if isAdmin();
    }
    
    // Donation Contracts - Users can only access their own
    match /donationContracts/{contractId} {
      // Allow users to read their own contracts
      allow read: if request.auth != null && 
                     resource.data.userId == request.auth.uid;
      // Allow users to create contracts for themselves
      allow create: if request.auth != null && 
                       request.resource.data.userId == request.auth.uid;
      // Allow users to update their own contracts (for withdrawals)
      allow update: if request.auth != null && 
                       resource.data.userId == request.auth.uid;
    }
    
    // P2P Payout Queue - Users can create their own withdrawal requests
    match /payout_queue/{payoutId} {
      // Allow users to create payout requests for themselves
      allow create: if isAdmin() || (request.auth != null && 
                       (request.resource.data.userId == request.auth.uid || request.resource.data.uid == request.auth.uid || request.resource.data.memberId == request.auth.uid));
      // Allow users to read their own payout requests
      allow read: if isAdmin() || (request.auth != null && 
                     (resource.data.userId == request.auth.uid || resource.data.uid == request.auth.uid || resource.data.memberId == request.auth.uid));
      // Only admins can update/delete
      allow update, delete: if isAdmin();
    }

    // ODHex Withdrawals - Users can submit and view their own requests
    match /odhexWithdrawals/{withdrawalId} {
      // Allow users to create ODHex withdrawal requests for themselves
      allow create: if isAdmin() || (request.auth != null &&
                       (request.resource.data.userId == request.auth.uid || request.resource.data.uid == request.auth.uid || request.resource.data.memberId == request.auth.uid));

      // Allow users to read only their own withdrawal requests
      allow read: if isAdmin() || (request.auth != null &&
                     (resource.data.userId == request.auth.uid || resource.data.uid == request.auth.uid || resource.data.memberId == request.auth.uid));

      // Updates/deletes are restricted to admins (via catch-all isAdmin rule)
      allow update, delete: if isAdmin();
    }
    
    // Legacy deposits collection (keep for backwards compatibility)
    match /deposits/{depositId} {
      allow read, write: if request.auth != null;
    }
    
    // Global Rewards - MANA daily reward pool
    match /globalRewards/{rewardId} {
      // Anyone authenticated can read the active reward to see the pool
      allow read: if request.auth != null;
      // Only allow writes through admin or Cloud Function
      allow write: if false;
    }
    
    // User Reward Claims - Track daily claims per user
    match /userRewardClaims/{userId} {
      // Users can read their own claim history
      allow read: if request.auth != null && 
                     request.auth.uid == userId;
      // Only allow writes through Cloud Function
      allow write: if false;
    }
    
    // Rewards History - Track all reward claims with expiration validation
    match /rewardsHistory/{historyId} {
      // Users and admins can read reward history
      allow read: if request.auth != null;
      
      // Validate that status is set correctly based on expiration when updating
      allow update: if isAdmin() && (
        // If updating to expired, ensure it's actually expired
        (request.resource.data.status == 'expired' && isRewardExpired(resource.data)) ||
        // If keeping as active, ensure it hasn't expired
        (request.resource.data.status == 'active' && !isRewardExpired(request.resource.data)) ||
        // Allow other status changes by admin
        request.resource.data.status == 'depleted'
      );
      
      // Allow creation by admin
      allow create: if isAdmin();
      allow delete: if isAdmin();
    }
    
    // Reward Claims - Track individual claims
    match /rewardClaims/{claimId} {
      // Users can read their own claims, admins can read all
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      // Only allow writes through Cloud Function
      allow write: if false;
    }
    
    // Claims collection (alternative/legacy)
    match /claims/{claimId} {
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid ||
        isAdmin()
      );
      allow write: if false;
    }
    
    // MANA Claim Analytics - Admin dashboard data
    match /manaClaimAnalytics/{analyticsId} {
      // Only admins can read analytics data
      allow read: if isAdmin();
      // Only allow writes through Cloud Function
      allow write: if false;
    }
    
    // Donations collection - Admin access
    match /donations/{donationId} {
      allow read, write: if isAdmin();
    }
    
    // Allow admins full access to remaining collections
    // This catch-all must come AFTER specific rules
    match /{document=**} {
      allow read, write: if isAdmin();
    }
  }
}
